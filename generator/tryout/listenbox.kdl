responsible syntax="0.0.1"

info {
    title "Listenbox"
    version "0.1"
    termsOfService "/terms"
}

servers {
    url "https://listenbox.app"
    url "http://localhost:3000"
}

newType "FeedID" "string" length=11

newType "ItemID" "string" length=11

newType "ShowID" "string" minLength=11 maxLength=12

newType "StripeCheckoutID" "string" minLength=1

struct "SubmitReq" {
    url "httpURL"
}

enum "Plan" {
    free
    basic
    premium
}

struct "UserResp" {
    email "email"
    plan "Plan"
    trialed "boolean"
    updates "boolean"
}

struct "RecentResp" {
    list "array" minItems=0 {
        struct {
            id "ShowID"
            feed_id "FeedID"
            title "string"
            episodes "nat32"
            (?)image "httpURL"
            (?)refreshed_utc "utcMillis"
            (?)author "string"
            (?)owner "string"
        }
    }
    plan "Plan"
}

enum "ValidationExceptionErrorType" {
    "NO_MATCH"
    "NOT_FOUND"
    "UNEXPECTED_ARRAY"
    "UNEXPECTED_SINGLE_STRING"
    "FILE_NOT_FOUND"
    "WRONG_CONTENT_TYPE"
    "EMPTY_VALUE"
    "UNEXPECTED_ARRAY_SIZE"
    "DESERIALIZATION_ERROR"
    "OBJECT_FIELD_NOT_FOUND"
    "JSON_NOT_PARSABLE"
    "JSON_INVALID"
    "XML_INVALID"
}

struct "ErrorStruct" {
    type "ValidationExceptionErrorType"
    name "string"
    value "string"
    (?)message "string"
}

struct "ITunesCategory" {
    category "string" minLength=1
    (?)subcategory "string" minLength=1
}

enum "YouTubeFeedType" {
    video
    playlist
    channel
}

struct "Show" {
    id "ShowID"
    feed_id "FeedID"
    audioFeedURL "httpURL"
    description "string"
    episodes "nat32"
    language "string"
    title "string"
    type "YouTubeFeedType"
    videoFeedURL "httpURL"
    youtubeURL "httpURL"
    (?)analyticsPrefix "httpURL"
    (?)author "string"
    (?)copyright "string"
    (?)explicit "boolean"
    (?)image "httpURL"
    (?)keywords "string"
    (?)owner "string"
    (?)ownerEmail "email"
    (?)primaryCategory "ITunesCategory"
    (?)secondaryCategory "ITunesCategory"
    (?)refreshedUTC "utcMillis"
    (?)reverse "boolean"
    (?)website "httpURL"
}

struct "EditShowReq" {
    explicit "boolean"
    language "string"
    owner "string"
    ownerEmail "email"
    (?)analyticsPrefix "httpURL"
    (?)author "string"
    (?)category1 "string"
    (?)category2 "string"
    (?)copyright "string"
    (?)description "string"
    (?)image "httpURL"
    (?)keywords "string"
    (?)subcategory1 "string"
    (?)subcategory2 "string"
    (?)title "string"
    (?)website "httpURL"
}

struct "JsonItem" {
    id "ItemID"
    title "string"
    webpage_url "httpURL"
    (?)duration_seconds "seconds"
    (?)image "httpURL"
    (?)mime "mime"
}

struct "ItemsResp" {
    items "array" "JsonItem" minItems=0
    total "nat32"
}

struct "PreSignedUploadURL" {
    fileUrl "httpURL"
    uploadUrl "httpURL"
    headers "dict" "string" "string"
}

struct "DownloadsChart" {

//    TODO figure out minItems
    list "array" {
        struct {
            day "utcMillis"
            downloads "nat32"
        }
    }
    total "nat64"
}

struct "ReverseReq" {
    showID "ShowID"
    value "boolean"
}

struct "ReverseResp" {
    value "boolean"
}

struct "LoginReq" {
    email "email"
    host "hostname"
}

"/japi" {

    scope {
        req {
            mime "application/json"
        }
        res {
            mime "application/json"

            header "Content-Length" "int32" minimum=1

            "400" "ErrorStruct"
        }
    }

    POST "/login" {
        name "requestOtp"

        req "LoginReq"

        res {
            "200" "struct" {
                login "enum" {
                    NEW
                    EXISTING
                }
            }
        }
    }

    POST "/otp" {
        name "submitOtp"

        req "struct" {
            email "email"
            otp "string" minLength=1
            (?)updates "boolean"
        }

        res {
            "201" "struct" {
                jwt "string" minLength=1
            }

            "401" "unknown"
        }
    }

    POST "/submit" {
        name "submitUrl"

        req {
            (?)header "authorization" "string" minLength=1
            body "SubmitReq"
        }

        res {
            "200" "struct" {
                showID "ShowID"
                plan "Plan"
            }

            "401" "unknown"
            "404" "unknown"
        }
    }

    GET "/show/:show_id" {
        name "getShow"

        req {
            pathParam "show_id" "ShowID"
            (?)header "authorization" "string" minLength=1
        }

        res {
            "200" "Show"
            "403" "unknown"
            "404" "unknown"
        }
    }

    GET "/show/:show_id/items" {
        name "getItems"

        req {
            pathParam "show_id" "ShowID"
            query {
                (?)before "dateTime"
                (?)limit "int32" minimum=1
            }
        }

        res {
            "200" "ItemsResp"
            "404" "unknown"
        }
    }

    POST "/unsubscribe" {
        name "unsubscribe"
        description "Unsubscribe the email from product updates"

        req "struct" {
            email "email"
        }

        res {
            "200" "unknown"
        }
    }

    "/auth" {

        scope {
            req {
                security {
                    OR {
                        header "authorization" "string" minLength=1
                        cookie "token" "string" minLength=1
                    }
                }
            }

            res {
                "401" "unknown"
            }
        }

        "/user" {
            GET {
                name "getUser"
                res {
                    "200" "UserResp"
                }
            }

            POST {
                name "patchUser"
                req "struct" {
                    updates "boolean"
                }
                res {
                    "200" "UserResp"
                }
            }

            DELETE {
                name "deleteUser"
                res {
                    "200" "UserResp"
                }
            }
        }

        GET "/recent" {
            name "recentFeeds"
            res {
                "200" "RecentResp"
            }
        }

        POST "/checkout" {
            name "checkout"

            req "struct" {
                plan "Plan"
                interval "enum" {
                    month
                    year
                }
                success_url "httpURL"
                cancel_url "httpURL"
            }

            res {
                "201" "struct" {
                    id "StripeCheckoutID"
                }
                "409" "unknown"
            }
        }

        POST "/portal" {
            name "customerPortal"
            req "struct" {
                return_url "httpURL"
            }
            res {
                "201" "struct" {
                    url "httpURL"
                }
            }
        }

        "/later" {
            GET {
                name "getLater"
                res {
                    "200" "Show"
                    "404" "unknown"
                }
            }

            POST {
                name "submitLater"
                req "SubmitReq"
                res {
                    "200" "ItemsResp"
                    "402" "unknown"
                }
            }
        }

        "/later/:item_id" {
            pathParam "item_id" "ItemID"

            POST {
                name "addLater"
                req "unknown"
                res {
                    "200" "unknown"
                    "402" "unknown"
                }
            }

            DELETE {
                name "removeLater"
                res {
                    "200" "unknown"
                }
            }
        }

        DELETE "/feed/:show_id" {
            name "deleteFeed"
            req {
                pathParam "show_id" "ShowID"
            }
            res {
                "200" "unknown"
            }
        }

        GET "/s3_presign_image" {
            name "preSignedImageUploadURL"

            req {
                query {
                    filename "string" minLength=1
                }
            }

            res {
                "200" "PreSignedUploadURL"
                "402" "unknown"
            }
        }

        PUT "/show/:show_id" {
            name "editShow"

            req {
                pathParam "show_id" "ShowID"
                body "EditShowReq"
            }

            res {
                "200" "Show"
                "403" "unknown"
                "404" "unknown"
            }
        }

        GET "/show/:show_id/downloads" {
            name "getDownloads"

            req {
                pathParam "show_id" "ShowID"
                query {
                    (?)timezone "string" minLength=1
                }
            }

            res {
                "200" "DownloadsChart"
                "403" "unknown"
            }
        }

        POST "/reverse" {
            name "reversePlaylist"
            req "ReverseReq"
            res {
                "200" "ReverseResp"
                "403" "unknown"
            }
        }
    }
}

"/oauth/google" {

    GET "/" {
        res {
            "302" {
                header "location" "httpURL"
            }
        }
    }

    GET "/callback" {
        req {
            query "code" "string" minLength=1
        }

        res {
            "302" {
                header "location" "httpURL"
                cookie "token" "string" minLength=1
            }
        }
    }
}

GET "/f/:show_id" head=true {
    name "audioRSS"

    req {
        pathParam "show_id" "ShowID"
    }

    res {
        "302" {
            header "Location" "httpURL"
        }

        "404" "unknown"
    }
}

GET "/v/:show_id" head=true {
    name "videoRSS"

    req {
        pathParam "show_id" "ShowID"
    }

    res {
        "302" {
            header "Location" "httpURL"
        }

        "404" "unknown"
    }
}

GET "/rss/:show_id/:type.rss" head=true {
    name "rss"

    req {
        pathParams {
            show_id "ShowID"
            type "enum" {
                audio
                video
            }
        }
    }

    res {
        "200" {
            headers {
                "content-length" "int32" minimum=1
                "etag" "string" minLength=1
            }
            body "application/rss+xml" "string" minLength=1
        }

        "404" "unknown"
    }
}
